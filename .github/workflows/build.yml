name: Full Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  Build-VisualCxx:
    runs-on: windows-latest
    strategy:
      matrix:
        arch:
          - x86
        toolset:
          - 14.0
          - 14.3

    steps:
    - uses: actions/checkout@v3
    - name: Enable Developer Command Prompt
      # You may pin to the exact commit or the version.
      # uses: ilammy/msvc-dev-cmd@d8610e2b41c6d0f0c3b4c46dad8df0fd826c68e1
      uses: ilammy/msvc-dev-cmd@v1.10.0
      with:
        arch: ${{ matrix.arch }}
        toolset: ${{ matrix.toolset }}
        #sdk:   # use the latest
        #spectre: # set true to use VC libraries with sepctre mitigations
    - name: Adjust setenv.bat
      shell: cmd
      run: sed -i 's/C:\\root//g' setenv.bat
    - name: Setup environment
      shell: cmd
      working-directory: ${{ github.workspace }}
      env:
        ROOT: ${{ github.workspace }}
      run: setenv.bat
    - name: Full Build
      shell: cmd
      working-directory: ${{ github.workspace }}\kermit\k95
      run: mk.bat
    - name: Make dist
      shell: cmd
      working-directory: ${{ github.workspace }}\kermit\k95
      run: mkdist.bat
    - name: Prepare Artifact
      run: |
        cd ${{ github.workspace }}
        cd kermit
        cd k95
        ren dist ckwin
        7z a -tzip "ckwin-vc${{ matrix.toolset }}-${{ matrix.arch }}.zip" ckwin
        move ckwin-vc${{ matrix.toolset }}-${{ matrix.arch }}.zip" ${{ github.workspace }}
      shell: cmd
    - name: Upload Artifact
      uses: actions/upload-artifact@v2.2.4
      with:
        name: ckwin-vc${{ matrix.toolset }}-${{ matrix.arch }}
        path: ckwin-vc${{ matrix.toolset }}-${{ matrix.arch }}.zip"
        if-no-files-found: error
        retention-days: 7
